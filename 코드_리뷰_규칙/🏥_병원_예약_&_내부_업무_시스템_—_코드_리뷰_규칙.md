# 🏥 병원 예약 & 내부 업무 시스템 — 코드 리뷰 규칙

> **문서 버전:** v1.0
**작성일:** 2026년
**적용 범위:** hospital-reservation (v4.1 / Spring Boot + Mustache SSR + Claude LLM)
**팀 구성:** 책임개발자 1명 + 개발자 3명 + AI 보조
**개발 기간:** 4주 (W1 ~ W4)
> 

---

## 목차

1. [기본 원칙 (마인드셋)](#1-기본-원칙-마인드셋)
2. [PR 작성 규칙](#2-pr-작성-규칙)
3. [리뷰 체크리스트](#3-리뷰-체크리스트)
4. [코멘트 작성 가이드](#4-코멘트-작성-가이드)
5. [리뷰 담당 & 에스컬레이션](#5-리뷰-담당--에스컬레이션)
6. [Merge 조건](#6-merge-조건)
7. [팀 문화 & 운영 규칙](#7-팀-문화--운영-규칙)
8. [리뷰 체크리스트 요약 (빠른 참조)](#-리뷰-체크리스트-요약-빠른-참조)

---

## 1. 기본 원칙 (마인드셋)

> 리뷰는 **"코드"** 를 개선하는 것이지, **"사람"** 을 평가하는 것이 아니다.
> 

| 원칙 | 내용 |
| --- | --- |
| 칭찬 먼저 | 좋은 부분은 적극적으로 언급한다. LGTM 한 줄만 쓰지 않는다. |
| 완벽보다 개선 | 완벽을 요구하면 W4에 병목이 발생한다. 지속적 개선을 추구한다. |
| 구역별 엄격도 구분 | 개발자 코드에는 관대하되, **보안·상태전이·LLM 호출** 관련은 엄격하게 검토한다. |
| 24시간 응답 목표 | PR 요청 후 **최대 24시간 이내** 1차 피드백을 목표로 한다. |

---

## 2. PR 작성 규칙

### 2.1 제목 형식

커밋 컨벤션과 동일한 prefix를 사용한다.

```
feat: 증상 입력 화면 + AI 추천 버튼 구현
fix:  예약 상태 전이 시 RESERVED로 잘못 저장되는 버그 수정
docs: API 명세서 챗봇 이력 항목 추가
chore: .gitignore API Key 설정 추가
```

### 2.2 본문 필수 항목

```markdown
## 변경 요약
무엇을 왜 바꿨는지 한 문장으로 작성

## 주요 변경 파일
- LlmService.java
- ReservationController.java
- symptom.mustache

## 테스트 방법
브라우저 확인 시 스크린샷 첨부 권장

## 특별히 봐줬으면 하는 부분
- LLM 프롬프트 구성 방식
- Security 설정 변경 여부

## 관련 이슈
closes #12
```

### 2.3 PR 크기 기준

| 크기 | 기준 | 조치 |
| --- | --- | --- |
| 권장 | **400줄 이하 / 파일 5개 이하** | 그대로 진행 |
| 주의 | 400 ~ 800줄 | 분할 검토 |
| 강제 분할 | **800줄 이상** | 책임개발자와 협의하여 분할 후 올리기 |

> 개발자가 분할 기준을 모를 경우 책임개발자가 함께 쪼개준다.
> 

---

## 3. 리뷰 체크리스트

> 리뷰어는 아래 **A → E 순서**로 확인한다. A가 통과되지 않으면 B 이후는 보지 않아도 된다.
> 

---

### ✅ A. 보안 & 안전 — **0순위 (가장 먼저)**

- [ ]  API Key, Claude Key 등 민감 정보가 코드에 **하드코딩되지 않았는가?**
- [ ]  LLM 호출은 반드시 **서버사이드(LlmService)** 에서만 이루어지는가?
- [ ]  ROLE 기반 URL 접근 제어가 제대로 동작하는가? (`@PreAuthorize`, Security Config 등)
- [ ]  허용되지 않는 상태 전이(완료→취소, 역방향 등)가 **Service 레이어에서 차단**되는가?
- [ ]  중복 예약 방지 로직 **(트랜잭션 + DB UNIQUE 제약)** 이 살아있는가?

---

### ✅ B. LLM 관련 특화 체크 — **1순위**

- [ ]  시스템 프롬프트에 `{departments_from_db}`, `{hospital_rules_from_db}` 가 **올바르게 치환**되는가?
- [ ]  Claude API **JSON 파싱 실패 시 폴백** (직접 선택 화면 전환) 처리가 되어 있는가?
- [ ]  **면책 고지 문구**(`disclaimer`)가 추천 결과 화면에 반드시 노출되는가?
- [ ]  `LLM_RECOMMENDATION` 테이블에 `is_used` 플래그가 **예약 확정 시 TRUE로 업데이트**되는가?
- [ ]  챗봇이 규칙 문서 외 질문에 **"등록된 규칙에서 확인할 수 없습니다"** 로 응답하는가?
- [ ]  **챗봇 대화 이력이 세션 단위로 저장**되는가? (ROLE_DOCTOR / ROLE_NURSE)
- [ ]  Claude API **타임아웃 5초** 설정이 적용되어 있는가?

---

### ✅ C. 기능·로직 — **2순위**

- [ ]  요구사항 **(프로젝트 계획서 v4.1 In-Scope)** 에 맞는가?
- [ ]  예외 상황 (잘못된 입력, API 실패, 빈 값 등) 처리가 되어 있는가?
- [ ]  `Controller → Service → Repository` 계층 분리가 적절한가?
- [ ]  `TreatmentRecord` 저장과 `Reservation.status = COMPLETED` 변경이 **단일 `@Transactional`** 로 묶여 있는가?

---

### ✅ D. 코드 품질 & 가독성 — **3순위**

- [ ]  변수·메서드·클래스 이름이 의도를 잘 드러내는가?
- [ ]  불필요한 중복 코드가 없는가?
- [ ]  `null` 체크, `Optional` 사용이 적절한가?
- [ ]  Lombok 과도 사용으로 가독성이 떨어지지 않는가?

---

### ✅ E. 테스트 & 문서 — **4순위**

- [ ]  Controller Acceptance Test 또는 Service 단위 테스트가 최소 1개 이상 존재하는가?
- [ ]  README, 주석, GitHub Wiki 등 문서 업데이트가 필요한 경우 반영되었는가?

---

## 4. 코멘트 작성 가이드

### 4.1 중요도 태그

모든 리뷰 코멘트 앞에 중요도 태그를 붙인다.

| 태그 | 의미 | 예시 상황 |
| --- | --- | --- |
| 🚨 **Blocking** | **반드시 수정 필요** — Merge 불가 | 보안 이슈, 상태전이 오류, LLM Key 노출 |
| ⚠️ **Change** | 수정하는 것이 좋음 | 트랜잭션 범위 오류, 폴백 누락 |
| 💡 **Suggestion** | 고려해볼 만한 개선 아이디어 | 코드 구조, 네이밍 개선 |
| ❓ **Question** | 의도 확인 필요 | 로직이 의도한 대로인지 불명확할 때 |

### 4.2 코멘트 예시

**칭찬 예시**

```
"폴백 로직 잘 넣어주셔서 LLM 실패 시에도 예약 흐름이 끊기지 않겠네요 👍"
"트랜잭션 범위 딱 맞게 잡아주셨어요. 이 부분 덕분에 안심됩니다."
```

**Blocking 예시**

```
🚨 Blocking
Claude API Key가 application.properties에 직접 기재되어 있습니다.
반드시 환경변수(${CLAUDE_API_KEY})로 변경 후 .gitignore에 등록해주세요.
```

**Change 예시**

```
⚠️ Change
챗봇 응답에 면책 고지 문구가 빠져있습니다.
추천 결과 화면에는 disclaimer 필드를 반드시 표시해야 합니다. (계획서 v4.1 2.1절 참고)
```

**Suggestion 예시**

```
💡 Suggestion
이 메서드가 꽤 길어졌네요. LLM 호출 부분과 파싱 부분을 별도 private 메서드로 분리하면
가독성이 좋아질 것 같습니다. 필수는 아닙니다.
```

**Question 예시**

```
❓ Question
여기서 is_used를 TRUE로 바꾸는 시점이 예약 확정 전인 것 같은데, 의도하신 건가요?
확정 실패 시에도 TRUE가 되면 추적이 어려울 수 있을 것 같아서요.
```

### 4.3 논쟁이 길어질 때

코멘트 교환이 **3회 이상** 반복되면 텍스트 토론을 멈추고 빠르게 해결한다.

```
"이 부분은 Discord에서 10분만 얘기하고 결정합시다."
```

---

## 5. 리뷰 담당 & 에스컬레이션

### 5.1 기본 리뷰 담당

| 구분 | 리뷰어 | 비고 |
| --- | --- | --- |
| 모든 PR | **책임개발자 (Tech Lead)** 필수 | 개발자 코드 품질 편차가 크기 때문에 책임개발자가 전담 |
| 개발자 간 리뷰 | Optional | 서로 배우는 용도 / 책임개발자 Approve 없으면 Merge 불가 |

### 5.2 LLM 관련 PR 우선순위

```
W3 말 ~ W4 전체 기간 동안
LLM 관련 PR (feature/llm-symptom, feature/llm-chatbot) 은
다른 PR보다 우선으로 리뷰한다.
```

### 5.3 W4 마지막 3일 운영 규칙

```
책임개발자 → 리뷰 집중 모드
개발자 → PR을 작게 자주 올려 대기열 최소화
목표: Blocking 코멘트 0개 상태로 W4 금요일 Merge 완료
```

### 5.4 블로킹 시 에스컬레이션

```
30분 이상 해결이 안 될 때 → Discord DM 즉시 에스컬레이션
책임개발자 응답 없을 때 → 1회 핑(@책임개발자 PR 리뷰 부탁드려요~)만 허용
```

---

## 6. Merge 조건

아래 조건을 **모두** 충족해야 Merge 가능하다.

| 조건 | 기준 |
| --- | --- |
| ✅ 책임개발자 Approve | 책임개발자 1명 이상 LGTM |
| ✅ Blocking 코멘트 | **0개** |
| ✅ 긍정 피드백 | 1개 이상 (LGTM 한 줄만 허용하지 않음) |
| ✅ CI 통과 | CI 파이프라인이 구성된 경우 통과 필수 |

---

## 7. 팀 문화 & 운영 규칙

### 7.1 주간 PR 회고 (매주 금요일 통합 미팅 중 10분)

```
"이번 주 가장 마음에 들었던 PR 한 개씩 소개하기"
→ 칭찬 문화 정착, 팀원 동기 유지
```

### 7.2 핑(Ping) 규칙

```
리뷰가 24시간 이상 없을 때 Discord/Slack에 핑 1회만 허용
"@책임개발자 PR 리뷰 부탁드려요~"
반복 핑 금지 — 책임개발자 리뷰 부하 관리
```

### 7.3 주차별 리뷰 강도

| 주차 | 리뷰 강도 | 포커스 |
| --- | --- | --- |
| W1 | 보통 | Security 설정, ERD 반영 여부 |
| W2 | 보통 | 예약 트랜잭션, 중복 방지 로직 |
| W3 | 높음 | 상태 전이 검증, LlmService 구조 |
| W4 | **최고** | LLM 통합 전체, 면책 고지, 보안 최종 점검 |

---

## 📋 리뷰 체크리스트 요약 (빠른 참조)

```
A. 보안 & 안전          ← 0순위, 실패 시 즉시 Blocking
   □ API Key 하드코딩 없음
   □ LLM 호출 서버사이드 전용
   □ ROLE URL 접근 제어 동작
   □ 상태 전이 역방향 차단
   □ 중복 예약 방지 이중 방어

B. LLM 특화             ← 1순위
   □ 프롬프트 DB 동적 주입 정상
   □ JSON 파싱 실패 폴백 처리
   □ 면책 고지 화면 표시
   □ is_used 플래그 업데이트
   □ 규칙 외 질문 거부 응답
   □ 챗봇 대화 이력 세션 저장
   □ 타임아웃 5초 설정

C. 기능·로직            ← 2순위
   □ In-Scope 요구사항 충족
   □ 예외 처리 존재
   □ 계층 분리 적절
   □ 단일 트랜잭션 처리

D. 코드 품질            ← 3순위
   □ 네이밍 의도 명확
   □ 중복 코드 없음
   □ null/Optional 적절 처리

E. 테스트 & 문서        ← 4순위
   □ 최소 테스트 1개
   □ 문서 업데이트 여부
```

---

*본 코드 리뷰 규칙은 프로젝트 계획서 v4.1을 기반으로 작성되었습니다.변경 발생 시 팀 동의 후 GitHub Wiki에서 버전 이력을 관리합니다.*